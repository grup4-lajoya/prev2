<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Control de Visitas Autorizadas</title>
<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="css/control-visitas.css">
</head>
<body>

<div class="container">
  <h1>üë• Control de Visitas Autorizadas</h1>
  
  <div class="controles-superiores">
    <div class="buscador">
      <input type="text" id="buscar" placeholder="Buscar por nombre, DNI, NSA...">
    </div>
    
    <div class="filtros">
      <select id="filtroEstado">
        <option value="">Todos los estados</option>
        <option value="activa">Activas</option>
        <option value="vencida">Vencidas</option>
        <option value="proxima">Pr√≥ximas</option>
      </select>
      
      <select id="filtroOrigen">
        <option value="">Todos los or√≠genes</option>
        <option value="unidad">Unidades</option>
        <option value="empresa">Empresas</option>
      </select>
    </div>
    
    <span class="info-registros" id="infoRegistros"></span>
  </div>

  <div class="tabla-container">
    <div class="loading" id="loading">Cargando visitas autorizadas... ‚è≥</div>
    <table id="tablaVisitas" style="display:none;">
      <thead>
        <tr>
          <th>N¬∞</th>
          <th>VISITANTE</th>
          <th>DNI/NSA</th>
          <th>ORIGEN</th>
          <th>VEH√çCULO</th>
          <th>FECHA INICIO</th>
          <th>FECHA FIN</th>
          <th>ESTADO</th>
          <th>ACCIONES</th>
        </tr>
      </thead>
      <tbody id="cuerpoTabla"></tbody>
    </table>
  </div>

  <div class="paginacion" id="paginacion" style="display:none;"></div>
</div>

<button class="btn-flotante" onclick="nuevaVisita()" title="Registrar Visita">+</button>

<div id="overlayGlobal" class="overlay-carga">
  <div class="overlay-content">
    <div class="spinner"></div>
    <p id="mensajeCarga">Procesando...</p>
  </div>
</div>

<!-- MODAL NUEVA VISITA -->
<div id="modalNueva" class="modal">
  <div class="modal-content modal-large">
    <div class="modal-header">
      <h2>üë• Registrar Visita Autorizada</h2>
      <span class="close" onclick="cerrarModal()">&times;</span>
    </div>
    
    <!-- INDICADOR DE PASOS -->
    <div class="wizard-steps">
      <div class="step active" id="indicadorPaso1">
        <div class="step-number">1</div>
        <div class="step-label">Visitante</div>
      </div>
      <div class="step-line"></div>
      <div class="step" id="indicadorPaso2">
        <div class="step-number">2</div>
        <div class="step-label">Veh√≠culo</div>
      </div>
      <div class="step-line"></div>
      <div class="step" id="indicadorPaso3">
        <div class="step-number">3</div>
        <div class="step-label">Autorizaci√≥n</div>
      </div>
    </div>
    
    <div class="modal-body">
      <form id="formNueva">
        
        <!-- ============================================
             PASO 1: SELECCIONAR/REGISTRAR VISITANTE
             ============================================ -->
        <div class="seccion" id="seccionVisitante">
          <div class="seccion-titulo">üë§ Paso 1: Seleccionar Visitante</div>
          
          <div class="mensaje-info">
            üí° Seleccione a la persona que visitar√° la unidad. Si no est√° registrada, puede agregarla usando el bot√≥n verde.
          </div>
          
          <div class="form-group">
            <label>Buscar Persona For√°nea <span class="required">*</span></label>
            <div class="autocomplete-wrapper">
              <input 
                type="text" 
                id="inputVisitante" 
                class="input-autocomplete" 
                placeholder="Escriba DNI, NSA, Pasaporte o nombre..."
                autocomplete="off"
                required>
              <div id="sugerenciasVisitante" class="sugerencias-dropdown"></div>
            </div>
            <input type="hidden" id="idVisitanteSeleccionado">
          </div>
          
          <button type="button" class="btn-nuevo-registro" onclick="abrirModalNuevoForaneo()">
            ‚ûï Registrar Nueva Persona
          </button>
          
          <div id="infoVisitanteSeleccionado" class="info-seleccionado" style="display:none;">
            <p><strong>Nombre:</strong> <span id="nombreVisitante"></span></p>
            <p><strong>DNI:</strong> <span id="dniVisitante"></span></p>
            <p><strong>NSA:</strong> <span id="nsaVisitante"></span></p>
            <p><strong>Pasaporte:</strong> <span id="pasaporteVisitante"></span></p>
            <p><strong>Origen:</strong> <span id="origenVisitante"></span></p>
          </div>

          <button type="button" class="btn-guardar-seccion" onclick="confirmarVisitante()" id="btnConfirmarVisitante" disabled>
            ‚úÖ Confirmar Visitante
          </button>
        </div>

        <!-- ============================================
             PASO 2: SELECCIONAR/REGISTRAR VEH√çCULO (OPCIONAL)
             ============================================ -->
        <div class="seccion bloqueada" id="seccionVehiculo">
          <div class="seccion-titulo">üöó Paso 2: Veh√≠culo (Opcional)</div>
          
          <div class="mensaje-info" id="mensajeBloqueoVehiculo">
            üîí Confirme primero al visitante.
          </div>

          <div id="formularioVehiculo" style="display:none;">
            <div class="visitante-confirmado" id="visitanteConfirmado" style="display:none;">
              <strong>Visitante:</strong> <span id="nombreVisitanteConfirmado"></span>
            </div>

            <div class="opciones-vehiculo">
              <label class="radio-option">
                <input type="radio" name="opcionVehiculo" value="sin_vehiculo" checked onchange="cambiarOpcionVehiculo()">
                <span>üö∂ Sin veh√≠culo</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="opcionVehiculo" value="existente" onchange="cambiarOpcionVehiculo()">
                <span>üöó Seleccionar veh√≠culo registrado</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="opcionVehiculo" value="nuevo" onchange="cambiarOpcionVehiculo()">
                <span>‚ûï Registrar nuevo veh√≠culo</span>
              </label>
            </div>

            <!-- SELECCIONAR VEH√çCULO EXISTENTE -->
            <div id="contenedorVehiculoExistente" class="sub-seccion" style="display:none;">
              <div class="form-group">
                <label>Buscar Veh√≠culo Registrado</label>
                <div class="autocomplete-wrapper">
                  <input 
                    type="text" 
                    id="inputVehiculo" 
                    class="input-autocomplete" 
                    placeholder="Escriba la placa del veh√≠culo..."
                    autocomplete="off">
                  <div id="sugerenciasVehiculo" class="sugerencias-dropdown"></div>
                </div>
                <input type="hidden" id="idVehiculoSeleccionado">
              </div>
              
              <div id="infoVehiculoSeleccionado" class="info-seleccionado" style="display:none;">
                <p><strong>Placa:</strong> <span id="placaVehiculo"></span></p>
                <p><strong>Tipo:</strong> <span id="tipoVehiculo"></span></p>
                <p><strong>Marca/Modelo:</strong> <span id="marcaModeloVehiculo"></span></p>
              </div>
            </div>

            <!-- REGISTRAR NUEVO VEH√çCULO -->
            <div id="contenedorVehiculoNuevo" class="sub-seccion" style="display:none;">
              <div class="mensaje-advertencia">
                ‚ö†Ô∏è Este veh√≠culo se registrar√° vinculado al visitante seleccionado.
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Placa <span class="required">*</span></label>
                  <input type="text" id="nuevaPlaca" maxlength="7" style="text-transform: uppercase;" placeholder="Ej: ABC-123">
                </div>
                <div class="form-group">
                  <label>Tipo de Veh√≠culo <span class="required">*</span></label>
                  <select id="nuevoTipoVehiculo">
                    <option value="">Seleccione</option>
                    <option value="AUTO">Autom√≥vil</option>
                    <option value="CAMIONETA">Camioneta</option>
                    <option value="MOTO">Motocicleta</option>
                    <option value="CAMI√ìN">Cami√≥n</option>
                    <option value="BUS">Bus</option>
                    <option value="OTRO">Otro</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Marca</label>
                  <input type="text" id="nuevaMarca" placeholder="Opcional">
                </div>
                <div class="form-group">
                  <label>Modelo</label>
                  <input type="text" id="nuevoModelo" placeholder="Opcional">
                </div>
              </div>

              <div class="form-group">
                <label>Color</label>
                <input type="text" id="nuevoColor" placeholder="Opcional">
              </div>
            </div>

            <button type="button" class="btn-guardar-seccion" onclick="confirmarVehiculo()" id="btnConfirmarVehiculo">
              ‚úÖ Confirmar Veh√≠culo
            </button>
          </div>
        </div>

        <!-- ============================================
             PASO 3: DATOS DE LA AUTORIZACI√ìN
             ============================================ -->
        <div class="seccion bloqueada" id="seccionAutorizacion">
          <div class="seccion-titulo">üìã Paso 3: Datos de la Autorizaci√≥n</div>
          
          <div class="mensaje-info" id="mensajeBloqueoAutorizacion">
            üîí Complete los pasos anteriores.
          </div>

          <div id="formularioAutorizacion" style="display:none;">
            <div class="resumen-confirmado" id="resumenConfirmado" style="display:none;">
              <p><strong>Visitante:</strong> <span id="resumenVisitante"></span></p>
              <p><strong>Veh√≠culo:</strong> <span id="resumenVehiculo"></span></p>
            </div>

            <div class="form-group">
              <label>Nombre de la Autorizaci√≥n <span class="required">*</span></label>
              <input type="text" id="nombreAutorizacion" placeholder="Ej: Visita de inspecci√≥n" required>
              <small>Este nombre aparecer√° en el listado y reporte</small>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Fecha de Inicio <span class="required">*</span></label>
                <input type="date" id="fechaInicio" required>
              </div>
              <div class="form-group">
                <label>Fecha de Fin <span class="required">*</span></label>
                <input type="date" id="fechaFin" required>
              </div>
            </div>

            <div class="form-group">
              <label>Motivo de la Visita</label>
              <textarea id="motivoVisita" rows="3" placeholder="Describa el motivo de la visita (opcional)"></textarea>
            </div>

            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="estadoVisita" checked>
                Autorizaci√≥n Activa
              </label>
            </div>

            <button type="button" class="btn-guardar-final" onclick="guardarVisita()" id="btnGuardarVisita">
              üíæ Guardar Visita Autorizada
            </button>
          </div>
        </div>

      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-cerrar" onclick="cerrarModal()">Cerrar</button>
    </div>
  </div>
</div>

<!-- ============================================
     MODAL: REGISTRAR NUEVA PERSONA FOR√ÅNEA
     ============================================ -->
<div id="modalNuevoForaneo" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>‚ûï Registrar Nueva Persona</h2>
      <span class="close" onclick="cerrarModalNuevoForaneo()">&times;</span>
    </div>
    <div class="modal-body">
      <form id="formNuevoForaneo">
        
        <div class="mensaje-info">
          üí° Complete los datos de la persona que visitar√° la unidad
        </div>

        <div class="form-group">
          <label>Nombre Completo <span class="required">*</span></label>
          <input type="text" id="nuevoForaneoNombre" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>DNI</label>
            <input type="text" id="nuevoForaneoDni" maxlength="8" placeholder="8 d√≠gitos">
          </div>
          <div class="form-group">
            <label>NSA</label>
            <input type="text" id="nuevoForaneoNsa" placeholder="Opcional">
          </div>
        </div>

        <div class="form-group">
          <label>Pasaporte</label>
          <input type="text" id="nuevoForaneoPasaporte" placeholder="Opcional">
        </div>

        <div class="mensaje-advertencia">
          ‚ö†Ô∏è Debe ingresar al menos uno: DNI, NSA o Pasaporte
        </div>

        <div class="form-group">
          <label>Tipo de Origen <span class="required">*</span></label>
          <select id="nuevoForaneoTipoOrigen" required onchange="cambiarTipoOrigen()">
            <option value="">Seleccione</option>
            <option value="unidad">Unidad</option>
            <option value="empresa">Empresa</option>
          </select>
        </div>

        <!-- Seleccionar Unidad -->
        <div id="contenedorUnidad" class="form-group" style="display:none;">
          <label>Unidad <span class="required">*</span></label>
          <div class="input-con-boton">
            <select id="nuevoForaneoUnidad" class="select-con-boton">
              <option value="">Seleccione una unidad</option>
            </select>
            <button type="button" class="btn-agregar-inline" onclick="abrirModalNuevaUnidad()" title="Agregar nueva unidad">
              ‚ûï
            </button>
          </div>
        </div>

        <!-- Seleccionar Empresa -->
        <div id="contenedorEmpresa" class="form-group" style="display:none;">
          <label>Empresa <span class="required">*</span></label>
          <div class="input-con-boton">
            <select id="nuevoForaneoEmpresa" class="select-con-boton">
              <option value="">Seleccione una empresa</option>
            </select>
            <button type="button" class="btn-agregar-inline" onclick="abrirModalNuevaEmpresa()" title="Agregar nueva empresa">
              ‚ûï
            </button>
          </div>
        </div>

        <button type="button" class="btn-guardar-final" onclick="guardarNuevoForaneo()">
          üíæ Guardar Persona
        </button>

      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-cerrar" onclick="cerrarModalNuevoForaneo()">Cancelar</button>
    </div>
  </div>
</div>

<!-- ============================================
     MODAL: REGISTRAR NUEVA UNIDAD
     ============================================ -->
<div id="modalNuevaUnidad" class="modal">
  <div class="modal-content modal-small">
    <div class="modal-header">
      <h2>üè¢ Registrar Nueva Unidad</h2>
      <span class="close" onclick="cerrarModalNuevaUnidad()">&times;</span>
    </div>
    <div class="modal-body">
      <form id="formNuevaUnidad">
        <div class="form-group">
          <label>Nombre de la Unidad <span class="required">*</span></label>
          <input type="text" id="nuevaUnidadNombre" required placeholder="Ej: Base A√©rea Las Palmas">
        </div>
        
        <button type="button" class="btn-guardar-final" onclick="guardarNuevaUnidad()">
          üíæ Guardar Unidad
        </button>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-cerrar" onclick="cerrarModalNuevaUnidad()">Cancelar</button>
    </div>
  </div>
</div>

<!-- ============================================
     MODAL: REGISTRAR NUEVA EMPRESA
     ============================================ -->
<div id="modalNuevaEmpresa" class="modal">
  <div class="modal-content modal-small">
    <div class="modal-header">
      <h2>üè≠ Registrar Nueva Empresa</h2>
      <span class="close" onclick="cerrarModalNuevaEmpresa()">&times;</span>
    </div>
    <div class="modal-body">
      <form id="formNuevaEmpresa">
        <div class="form-group">
          <label>RUC</label>
          <input type="text" id="nuevaEmpresaRuc" maxlength="11" placeholder="11 d√≠gitos (opcional)">
        </div>
        
        <div class="form-group">
          <label>Nombre de la Empresa <span class="required">*</span></label>
          <input type="text" id="nuevaEmpresaNombre" required placeholder="Ej: Constructora SAC">
        </div>
        
        <button type="button" class="btn-guardar-final" onclick="guardarNuevaEmpresa()">
          üíæ Guardar Empresa
        </button>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-cerrar" onclick="cerrarModalNuevaEmpresa()">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL VER DETALLE -->
<div id="modalVerDetalle" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üëÅ Detalle de Visita Autorizada</h2>
      <span class="close" onclick="cerrarModalVerDetalle()">&times;</span>
    </div>
    <div class="modal-body">
      
      <div class="seccion info-vehiculo">
        <div class="seccion-titulo">üë§ Informaci√≥n del Visitante</div>
        <div class="info-grid">
          <div class="info-item"><strong>Nombre:</strong><span id="verNombreVisitante">-</span></div>
          <div class="info-item"><strong>DNI:</strong><span id="verDniVisitante">-</span></div>
          <div class="info-item"><strong>NSA:</strong><span id="verNsaVisitante">-</span></div>
          <div class="info-item"><strong>Pasaporte:</strong><span id="verPasaporteVisitante">-</span></div>
          <div class="info-item"><strong>Origen:</strong><span id="verOrigenVisitante">-</span></div>
        </div>
      </div>

      <div class="seccion info-vehiculo">
        <div class="seccion-titulo">üöó Informaci√≥n del Veh√≠culo</div>
        <div class="info-grid">
          <div class="info-item"><strong>Placa:</strong><span id="verPlacaVehiculo">-</span></div>
          <div class="info-item"><strong>Tipo:</strong><span id="verTipoVehiculoDetalle">-</span></div>
          <div class="info-item"><strong>Marca/Modelo:</strong><span id="verMarcaModeloDetalle">-</span></div>
          <div class="info-item"><strong>Color:</strong><span id="verColorVehiculo">-</span></div>
        </div>
      </div>

      <div class="seccion info-vehiculo">
        <div class="seccion-titulo">üìã Datos de la Autorizaci√≥n</div>
        <div class="info-grid">
          <div class="info-item"><strong>Nombre:</strong><span id="verNombreAutorizacion">-</span></div>
          <div class="info-item"><strong>Fecha Inicio:</strong><span id="verFechaInicio">-</span></div>
          <div class="info-item"><strong>Fecha Fin:</strong><span id="verFechaFin">-</span></div>
          <div class="info-item"><strong>Estado:</strong><span id="verEstadoVisita">-</span></div>
          <div class="info-item" style="grid-column: 1 / -1;">
            <strong>Motivo:</strong><span id="verMotivoVisita">-</span>
          </div>
        </div>
      </div>

    </div>
    <div class="modal-footer">
      <button type="button" class="btn-cerrar" onclick="cerrarModalVerDetalle()">Cerrar</button>
    </div>
  </div>
</div>
  <!-- MODAL EDITAR -->
<div id="modalEditar" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>‚úèÔ∏è Editar Visita Autorizada</h2>
      <span class="close" onclick="cerrarModalEditar()">&times;</span>
    </div>
    <div class="modal-body">
      <form id="formEditar">
        
        <input type="hidden" id="editIdVisita">
        
        <div class="seccion">
          <div class="seccion-titulo">üë§ Informaci√≥n del Visitante (solo lectura)</div>
          <div class="mensaje-info">
            ‚ÑπÔ∏è No se puede cambiar el visitante ni el veh√≠culo. Si necesita hacerlo, elimine esta visita y cree una nueva.
          </div>
          <div class="info-propietario-readonly">
            <p><strong>Nombre:</strong> <span id="editNombreVisitante"></span></p>
            <p><strong>DNI:</strong> <span id="editDniVisitante"></span></p>
            <p><strong>NSA:</strong> <span id="editNsaVisitante"></span></p>
            <p><strong>Pasaporte:</strong> <span id="editPasaporteVisitante"></span></p>
            <p><strong>Origen:</strong> <span id="editOrigenVisitante"></span></p>
            <p><strong>Veh√≠culo:</strong> <span id="editVehiculoVisitante"></span></p>
          </div>
        </div>

        <div class="seccion">
          <div class="seccion-titulo">üìã Datos de la Autorizaci√≥n (Editable)</div>
          
          <div class="form-group">
            <label>Nombre de la Autorizaci√≥n <span class="required">*</span></label>
            <input type="text" id="editNombreAutorizacion" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Fecha de Inicio <span class="required">*</span></label>
              <input type="date" id="editFechaInicio" required>
            </div>
            <div class="form-group">
              <label>Fecha de Fin <span class="required">*</span></label>
              <input type="date" id="editFechaFin" required>
            </div>
          </div>

          <div class="form-group">
            <label>Motivo de la Visita</label>
            <textarea id="editMotivoVisita" rows="3"></textarea>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="editEstadoVisita">
              Autorizaci√≥n Activa
            </label>
          </div>

          <button type="button" class="btn-guardar-final" onclick="actualizarVisita()">
            üíæ Actualizar Visita
          </button>
        </div>

      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-cerrar" onclick="cerrarModalEditar()">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL DE CONFIRMACI√ìN -->
<div id="modalConfirmacion" class="modal-confirmacion">
  <div class="modal-confirmacion-content">
    <div class="modal-confirmacion-header">
      <span id="tituloConfirmacion">Confirmar acci√≥n</span>
    </div>
    <div class="modal-confirmacion-body">
      <p id="mensajeConfirmacion">¬øEst√° seguro de realizar esta acci√≥n?</p>
    </div>
    <div class="modal-confirmacion-footer">
      <button class="btn-confirmar-no" onclick="cerrarConfirmacion(false)">No, Cancelar</button>
      <button class="btn-confirmar-si" onclick="cerrarConfirmacion(true)">S√≠, Continuar</button>
    </div>
  </div>
</div>

<script src="js/control-visitas.js"></script>
</body>
</html>

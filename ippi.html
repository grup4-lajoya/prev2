<!-- ippi.html -->
<style>
  #formulario-container {
    max-width: 1200px;
    margin: 40px auto;
    padding: 30px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    font-family: Arial, sans-serif;
  }

  #formulario-container h1 {
    text-align: center;
    margin-bottom: 20px;
    color: #003366;
  }

  #tablaIPPI {
    width: 100%;              /* ocupa todo el ancho disponible */
    border-collapse: collapse;
    font-size: 0.95em;
    table-layout: auto;        /* ajuste automÃ¡tico de columnas */
  }

  #tablaIPPI thead tr {
    background: #002147;
    color: #fff;
    text-align: center;
    font-weight: bold;
  }

  #tablaIPPI th,
  #tablaIPPI td {
    border: 1px solid #ccc;
    padding: 12px;
    vertical-align: middle;
    text-align: left;
    word-wrap: break-word;    /* partir texto largo */
    white-space: normal;      /* saltos de lÃ­nea */
  }

  #tablaIPPI thead th {
    position: sticky;
    top: 0;
    background: #002147;
    z-index: 2;
  }

  #tablaIPPI tbody tr:nth-child(even) {
    background-color: #f9f9f9;
  }

  #tablaIPPI select,
  #tablaIPPI textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 0.9em;
    box-sizing: border-box;
  }

  #tablaIPPI textarea {
    min-height: 60px;
    resize: vertical; /* permite al usuario agrandar si lo necesita */
  }

  #tablaIPPI button {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    background-color: #0056A6;
    color: #fff;
    font-size: 0.9em;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;
  }

  #tablaIPPI button:hover {
    background-color: #003366;
  }
</style>

<div id="formulario-container">
  <h1 class="titulo-seccion">IPPIÂ´s - gestiÃ³n</h1>

  <table id="tablaIPPI">
    <thead>
      <tr>
        <th>nÂ°</th>
        <th>fecha y hora</th>
        <th>informe</th>
        <th>lugar</th>
        <th>descripciÃ³n</th>
        <th>recomendaciones</th>
        <th>nombre</th>
        <th>archivos</th>
        <th>estado</th>
        <th>acciÃ³n tomada</th>
        <th>guardar</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const urlIPPI = "TU_URL_DEL_APPS_SCRIPT_O_CSV_PUBLICO"; 
const urlActualizar = "TU_URL_DEL_APPS_SCRIPT_PARA_ACTUALIZAR"; 

// ðŸ‘‰ FunciÃ³n para dar formato a fecha y hora
function formatearFecha(fechaStr) {
  if (!fechaStr) return "";
  const fecha = new Date(fechaStr);
  if (isNaN(fecha)) return fechaStr; // si no se puede parsear, se muestra tal cual

  const dia = String(fecha.getDate()).padStart(2, "0");
  const mes = String(fecha.getMonth() + 1).padStart(2, "0");
  const anio = fecha.getFullYear();

  const horas = String(fecha.getHours()).padStart(2, "0");
  const minutos = String(fecha.getMinutes()).padStart(2, "0");

  return `${dia}/${mes}/${anio} - ${horas}:${minutos}`;
}

function cargarIPPI() {
  fetch(urlIPPI)
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#tablaIPPI tbody");
      tbody.innerHTML = "";
      data.forEach((row, index) => {
        const tr = document.createElement("tr");

        const archivos = row["SUBIR IMAGEN O VIDEO (Opcional)"] 
          ? row["SUBIR IMAGEN O VIDEO (Opcional)"].split(", ").map(url => 
              `<a href="${url}" target="_blank" style="text-decoration:none; margin-right:5px;">
                 <img src="https://img.icons8.com/ios-filled/20/0056A6/picture.png" alt="ver archivo"/>
               </a>`).join("") 
          : "";

        tr.innerHTML = `
          <td class="numero" style="text-align:center;"></td>
          <td>${formatearFecha(row["Marca temporal"])}</td>
          <td>${row["INFORME (asunto breve)"]||""}</td>
          <td>${row["LUGAR DEL ACTO O CONDICIÃ“N INSEGURA"]||""}</td>
          <td>${row["DESCRIPCIÃ“N (Hacer una descripciÃ³n completa de la ocurrencia)"]||""}</td>
          <td>${row["RECOMENDACIONES"]||""}</td>
          <td>${row["NOMBRE DE QUIEN REPORTA (Opcional)"]||""}</td>
          <td style="text-align:center;">${archivos}</td>
          <td>
            <select name="ESTADO">
              <option value="">seleccionar</option>
              <option value="Pendiente" ${row["ESTADO"]==="Pendiente"?'selected':''}>pendiente</option>
              <option value="En proceso" ${row["ESTADO"]==="En proceso"?'selected':''}>en proceso</option>
              <option value="Solucionado" ${row["ESTADO"]==="Solucionado"?'selected':''}>solucionado</option>
            </select>
          </td>
          <td>
            <textarea name="ACCION_TOMADA" placeholder="acciÃ³n tomada">${row["ACCIÃ“N TOMADA"]||''}</textarea>
          </td>
          <td style="text-align:center;">
            <button data-index="${index}">guardar</button>
          </td>
        `;
        tbody.appendChild(tr);

        // Evento de guardar fila
        tr.querySelector("button").addEventListener("click", () => {
          const estado = tr.querySelector("select[name='ESTADO']").value;
          const accion = tr.querySelector("textarea[name='ACCION_TOMADA']").value;
          
          const formData = new FormData();
          formData.append("filaIndex", index);
          formData.append("ESTADO", estado);
          formData.append("ACCION_TOMADA", accion);

          fetch(urlActualizar, {
            method: "POST",
            body: formData
          })
          .then(res => res.text())
          .then(data => {
            alert("Fila actualizada âœ…");
            renumerarFilas();
          })
          .catch(err => alert("Error al guardar âŒ " + err));
        });
      });

      renumerarFilas();
    })
    .catch(err => console.error("Error al cargar datos:", err));
}

function renumerarFilas() {
  document.querySelectorAll("#tablaIPPI tbody tr").forEach((tr, idx) => {
    tr.querySelector(".numero").textContent = idx + 1;
  });
}

cargarIPPI();
</script>


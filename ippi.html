<!-- formulario.html -->
<div id="formulario-container" style="max-width:950px; margin:0 auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
  <h1 class="titulo-seccion" style="text-align:center;">IPPI´s - Gestión</h1>

  <table id="tablaIPPI" style="width:100%; border-collapse: collapse; margin-top:20px;">
    <thead>
      <tr style="background:#002147; color:#fff;">
        <th style="border:1px solid #ccc; padding:8px;">#</th>
        <th style="border:1px solid #ccc; padding:8px;">Marca temporal</th>
        <th style="border:1px solid #ccc; padding:8px;">Informe</th>
        <th style="border:1px solid #ccc; padding:8px;">Fecha</th>
        <th style="border:1px solid #ccc; padding:8px;">Hora</th>
        <th style="border:1px solid #ccc; padding:8px;">Lugar</th>
        <th style="border:1px solid #ccc; padding:8px;">Descripción</th>
        <th style="border:1px solid #ccc; padding:8px;">Recomendaciones</th>
        <th style="border:1px solid #ccc; padding:8px;">Nombre</th>
        <th style="border:1px solid #ccc; padding:8px;">Archivos</th>
        <th style="border:1px solid #ccc; padding:8px;">ESTADO</th>
        <th style="border:1px solid #ccc; padding:8px;">ACCIÓN TOMADA</th>
        <th style="border:1px solid #ccc; padding:8px;">Guardar</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const urlIPPI = "TU_URL_DEL_APPS_SCRIPT_O_CSV_PUBLICO"; 
const urlActualizar = "TU_URL_DEL_APPS_SCRIPT_PARA_ACTUALIZAR"; 

function cargarIPPI() {
  fetch(urlIPPI)
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#tablaIPPI tbody");
      tbody.innerHTML = "";
      data.forEach((row, index) => {
        const tr = document.createElement("tr");

        const archivos = row["SUBIR IMAGEN O VIDEO (Opcional)"] 
          ? row["SUBIR IMAGEN O VIDEO (Opcional)"].split(", ").map(url => 
              `<a href="${url}" target="_blank" style="text-decoration:none; margin-right:5px;">
                 <img src="https://img.icons8.com/ios-filled/24/0056A6/picture.png" alt="Ver archivo"/>
               </a>`).join("") 
          : "";

        tr.innerHTML = `
          <td class="numero" style="border:1px solid #ccc; padding:8px; text-align:center;"></td>
          <td style="border:1px solid #ccc; padding:8px;">${row["Marca temporal"]||""}</td>
          <td style="border:1px solid #ccc; padding:8px;">${row["INFORME (asunto breve)"]||""}</td>
          <td style="border:1px solid #ccc; padding:8px;">${row["fecha"]||""}</td>
          <td style="border:1px solid #ccc; padding:8px;">${row["Hora"]||""}</td>
          <td style="border:1px solid #ccc; padding:8px;">${row["LUGAR DEL ACTO O CONDICIÓN INSEGURA"]||""}</td>
          <td style="border:1px solid #ccc; padding:8px;">${row["DESCRIPCIÓN (Hacer una descripción completa de la ocurrencia)"]||""}</td>
          <td style="border:1px solid #ccc; padding:8px;">${row["RECOMENDACIONES"]||""}</td>
          <td style="border:1px solid #ccc; padding:8px;">${row["NOMBRE DE QUIEN REPORTA (Opcional)"]||""}</td>
          <td style="border:1px solid #ccc; padding:8px; text-align:center;">${archivos}</td>
          <td style="border:1px solid #ccc; padding:8px;">
            <select name="ESTADO" style="width:100%; padding:6px; border-radius:4px; border:1px solid #ccc;">
              <option value="">Seleccionar</option>
              <option value="Pendiente" ${row["ESTADO"]==="Pendiente"?'selected':''}>Pendiente</option>
              <option value="En proceso" ${row["ESTADO"]==="En proceso"?'selected':''}>En proceso</option>
              <option value="Solucionado" ${row["ESTADO"]==="Solucionado"?'selected':''}>Solucionado</option>
            </select>
          </td>
          <td style="border:1px solid #ccc; padding:8px;">
            <textarea name="ACCION_TOMADA" placeholder="Acción tomada" style="width:100%; height:60px; border-radius:4px; border:1px solid #ccc; padding:6px;">${row["ACCIÓN TOMADA"]||''}</textarea>
          </td>
          <td style="border:1px solid #ccc; padding:8px; text-align:center;">
            <button data-index="${index}" style="padding:6px 12px; border:none; border-radius:6px; background:#0056A6; color:#fff; cursor:pointer;">Guardar</button>
          </td>
        `;
        tbody.appendChild(tr);

        // Evento de guardar fila
        tr.querySelector("button").addEventListener("click", () => {
          const estado = tr.querySelector("select[name='ESTADO']").value;
          const accion = tr.querySelector("textarea[name='ACCION_TOMADA']").value;
          
          const formData = new FormData();
          formData.append("filaIndex", index);
          formData.append("ESTADO", estado);
          formData.append("ACCION_TOMADA", accion);

          fetch(urlActualizar, {
            method: "POST",
            body: formData
          })
          .then(res => res.text())
          .then(data => {
            alert("Fila actualizada ✅");
            renumerarFilas(); // actualizar numeración
          })
          .catch(err => alert("Error al guardar ❌ " + err));
        });
      });

      // Al terminar de cargar, numeramos
      renumerarFilas();
    })
    .catch(err => console.error("Error al cargar datos:", err));
}

// Función para renumerar filas dinámicamente
function renumerarFilas() {
  document.querySelectorAll("#tablaIPPI tbody tr").forEach((tr, idx) => {
    tr.querySelector(".numero").textContent = idx + 1;
  });
}

// Ejecutar al cargar el HTML
cargarIPPI();
</script>


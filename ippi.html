<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Consulta de Informes de Peligros Potenciales e Incidentes</title>
<style>
body {
  font-family: Arial, sans-serif;
  background-color: #f4f6fa;
  margin: 0;
  padding: 0;
}
h2 {
  text-align: center;
  color: #002147;
  margin-bottom: 20px;
  font-size: 1.3rem;
}
.container {
  width: 100%;
  max-width: 1600px;
  margin: 0 auto;
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  box-sizing: border-box;
  overflow-x: auto;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
  table-layout: fixed;
}
th {
  background-color: #003366;
  color: white;
  font-size: 0.75rem;
  font-weight: 500;
  text-transform: uppercase;
  text-align: center;
  padding: 6px;
  white-space: nowrap;
}
td {
  border: 1px solid #ddd;
  padding: 6px 8px;
  font-size: 0.82rem;
  vertical-align: top;
  text-align: center;
  word-wrap: break-word;
  white-space: normal;
  max-width: 200px;
}
td.asunto, td.lugar, td.reporta, td.acciones {
  text-align: left;
}
/* Contenedores internos para scroll en campos largos */
td .scroll-cell {
  max-height: 100px;
  overflow-y: auto;
  word-wrap: break-word;
  text-align: left;
}
tr:nth-child(even) {
  background-color: #f9f9f9;
}
.icono {
  cursor: pointer;
  color: #0056A6;
  font-weight: bold;
}
th:nth-child(1) { width: 4%; }
th:nth-child(2) { width: 10%; }
th:nth-child(3) { width: 8%; }
th:nth-child(4) { width: 8%; }
th:nth-child(5) { width: 18%; }
th:nth-child(6) { width: 15%; }
th:nth-child(7) { width: 10%; }
th:nth-child(8) { width: 7%; }
th:nth-child(9) { width: 8%; }
th:nth-child(10){ width: 15%; }
th:nth-child(11){ width: 6%; }
input.accion-input {
  width: 90%;
  padding: 4px;
  font-size: 0.8rem;
}
button.accion-btn {
  padding: 3px 6px;
  font-size: 0.75rem;
  cursor: pointer;
  background-color: #0056A6;
  color: white;
  border: none;
  border-radius: 4px;
}
button.accion-btn:hover {
  background-color: #003366;
}
/* Miniaturas de imágenes */
.miniatura {
  width: 40px;
  height: 40px;
  object-fit: cover;
  margin: 2px;
  cursor: pointer;
  border-radius: 4px;
  border: 1px solid #ccc;
  transition: transform 0.2s;
}
.miniatura:hover {
  transform: scale(1.3);
  border-color: #0056A6;
}
/* Paginación */
.pagination {
  margin-top: 10px;
  text-align: center;
}
.pagination button {
  padding: 5px 10px;
  margin: 0 2px;
  border: none;
  border-radius: 4px;
  background-color: #003366;
  color: white;
  cursor: pointer;
}
.pagination button.active {
  background-color: #0056A6;
}
</style>
</head>
<body>
<div class="container">
<h2>CONSULTA DE INFORMES DE PELIGROS POTENCIALES E INCIDENTES</h2>
<table id="data-table">
  <thead>
    <tr>
      <th>N°</th>
      <th>FECHA Y HORA</th>
      <th>ASUNTO</th>
      <th>LUGAR</th>
      <th>DESCRIPCIÓN</th>
      <th>RECOMENDACIONES</th>
      <th>REPORTA</th>
      <th>IMÁGENES</th>
      <th>ESTADO</th>
      <th>ACCIONES TOMADAS</th>
      <th>ACCIÓN</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<div class="pagination" id="pagination"></div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwi8X15CNxU10c48V1MUYbb9ZiT-2s2sxJFeSDTuuaMjkw1Qqo-mLFF6tLsh6Phplgn/exec";
const filasPorPagina = 5;
let datos = [];
let paginaActual = 1;

async function cargarDatos() {
  try {
    const response = await fetch(SCRIPT_URL);
    datos = await response.json();
    mostrarPagina(1);
  } catch (error) {
    console.error("Error cargando los datos:", error);
  }
}

function mostrarPagina(pagina) {
  const tbody = document.querySelector("#data-table tbody");
  tbody.innerHTML = "";
  paginaActual = pagina;
  const inicio = (pagina - 1) * filasPorPagina;
  const fin = inicio + filasPorPagina;
  const paginaDatos = datos.slice(inicio, fin);

  paginaDatos.forEach((row, index) => {
    const tr = document.createElement("tr");
    // Miniaturas
    let imagenesHTML = "";
    if(row["archivos"]) {
      const urls = row["archivos"].split(",");
      imagenesHTML = urls.map(url => 
        `<img src="${url.trim()}" class="miniatura" onclick="window.open('${url.trim()}', '_blank')" title="Ver imagen">`
      ).join(" ");
    }

    tr.innerHTML = `
      <td>${inicio + index + 1}</td>
      <td>${row["marca temporal"] || ""}</td>
      <td class="asunto">${row["informe"] || ""}</td>
      <td class="lugar">${row["lugar"] || ""}</td>
      <td class="descripcion"><div class="scroll-cell">${row["descripcion"] || ""}</div></td>
      <td class="recomendaciones"><div class="scroll-cell">${row["recomendaciones"] || ""}</div></td>
      <td class="reporta">${row["nombre"] || ""}</td>
      <td>${imagenesHTML}</td>
      <td>${row["estado"] || ""}</td>
      <td class="acciones">${row["accion tomada"] || ""}</td>
      <td>
        <input type="text" class="accion-input" value="${row['guardar'] || ''}">
        <button class="accion-btn" data-row="${inicio + index}">Guardar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // Paginación
  const totalPaginas = Math.ceil(datos.length / filasPorPagina);
  const pagDiv = document.getElementById("pagination");
  pagDiv.innerHTML = "";
  for(let i=1; i<=totalPaginas; i++){
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.classList.toggle("active", i === pagina);
    btn.addEventListener("click", ()=>mostrarPagina(i));
    pagDiv.appendChild(btn);
  }
}

document.addEventListener('click', async function(e){
  if(e.target && e.target.classList.contains('accion-btn')){
    const rowIndex = e.target.dataset.row;
    const input = e.target.previousElementSibling;
    const valor = input.value;

    try {
      const formData = new FormData();
      formData.append('row', parseInt(rowIndex) + 2);
      formData.append('accion', valor);

      await fetch(SCRIPT_URL, { method: 'POST', body: formData });
      alert('Acción guardada correctamente ✅');
    } catch(err){
      alert('Error al guardar ❌ '+err);
    }
  }
});

window.onload = cargarDatos;
</script>
</body>
</html>


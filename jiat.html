<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JIAT - Informaci√≥n de las Juntas de Investigaci√≥n de Accidentes Terrestres</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: Arial, sans-serif;
    background-color: #f4f6fa;
    color: #222;
    padding: 20px;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  h1 {
    color: #002147;
    margin-bottom: 30px;
    font-size: 2rem;
  }

  /* Bot√≥n flotante */
  .btn-flotante {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    background-color: #0056A6;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 2rem;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transition: all 0.3s;
    z-index: 1000;
  }

  .btn-flotante:hover {
    background-color: #003366;
    transform: scale(1.1);
  }

  /* Tabla */
  .tabla-container {
    overflow-x: auto;
    margin-bottom: 20px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  thead {
    background-color: #002147;
    color: white;
  }

  th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }

  th {
    font-weight: 600;
    position: sticky;
    top: 0;
  }

  tbody tr:hover {
    background-color: #f0f4ff;
  }

  /* Iconos de acci√≥n */
  .acciones {
    display: flex;
    gap: 10px;
  }

  .btn-icono {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9rem;
  }

  .btn-ver {
    background-color: #17a2b8;
    color: white;
  }

  .btn-ver:hover {
    background-color: #138496;
  }

  .btn-registrar {
    background-color: #28a745;
    color: white;
  }

  .btn-registrar:hover {
    background-color: #218838;
  }

  .btn-editar {
    background-color: #ffc107;
    color: white;
  }

  .btn-editar:hover {
    background-color: #e0a800;
  }

  .btn-eliminar {
    background-color: #dc3545;
    color: white;
  }

  .btn-eliminar:hover {
    background-color: #c82333;
  }

  /* Paginaci√≥n */
  .paginacion {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 20px;
  }

  .paginacion button {
    padding: 8px 16px;
    border: 1px solid #0056A6;
    background-color: white;
    color: #0056A6;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.3s;
  }

  .paginacion button:hover:not(:disabled) {
    background-color: #0056A6;
    color: white;
  }

  .paginacion button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .paginacion .activo {
    background-color: #0056A6;
    color: white;
  }

  .paginacion span {
    color: #666;
  }

  /* Buscador */
  .buscador {
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .buscador input {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
  }

  .info-registros {
    color: #666;
    font-size: 0.9rem;
  }

  /* Loading */
  .loading {
    text-align: center;
    padding: 40px;
    color: #0056A6;
    font-size: 1.2rem;
  }
</style>
</head>
<body>

<div class="container">
  <h1>JIAT - Informaci√≥n de las Juntas de Investigaci√≥n de Accidentes Terrestres</h1>
  
  <div class="buscador">
    <input type="text" id="buscar" placeholder="Buscar por unidad, c√≥digo o fecha...">
    <span class="info-registros" id="infoRegistros"></span>
  </div>

  <div class="tabla-container">
    <div class="loading" id="loading">Cargando datos...</div>
    <table id="tablaJIAT" style="display:none;">
      <thead>
        <tr>
          <th>N¬∞</th>
          <th>UNIDAD</th>
          <th>C√ìDIGO</th>
          <th>FECHA</th>
          <th>FATAL</th>
          <th>ACCIONES</th>
        </tr>
      </thead>
      <tbody id="cuerpoTabla">
      </tbody>
    </table>
  </div>

  <div class="paginacion" id="paginacion" style="display:none;"></div>
</div>

<button class="btn-flotante" onclick="nuevoRegistro()" title="Nuevo Registro">+</button>

<script>
  let datosCompletos = [];
  let datosFiltrados = [];
  let paginaActual = 1;
  const registrosPorPagina = 10;

  // Cargar datos del Excel al cargar la p√°gina
  window.onload = function() {
    cargarDatosExcel();
  };

  async function cargarDatosExcel() {
    try {
      // URL de tu Web App de Apps Script
      const URL_APPS_SCRIPT = 'https://script.google.com/macros/s/AKfycbxIeRDr8R2JAQ39AlFW4f8hOrhMmvaJvuAOGwfOurjmUKn57xdXQ8t-70WweSkAorwy/exec';
      
      const response = await fetch(URL_APPS_SCRIPT + '?action=obtenerJIAT');
      const datos = await response.json();
      
      if (datos.error) {
        throw new Error(datos.error);
      }
      
      datosCompletos = datos;
      datosFiltrados = [...datosCompletos];
      
      document.getElementById('loading').style.display = 'none';
      document.getElementById('tablaJIAT').style.display = 'table';
      document.getElementById('paginacion').style.display = 'flex';
      
      actualizarTabla();
    } catch (error) {
      console.error('Error al cargar los datos:', error);
      document.getElementById('loading').innerHTML = 
        'Error al cargar los datos. Por favor, verifica la conexi√≥n con Apps Script.';
    }
  }

  function actualizarTabla() {
    const inicio = (paginaActual - 1) * registrosPorPagina;
    const fin = inicio + registrosPorPagina;
    const datosPagina = datosFiltrados.slice(inicio, fin);
    
    const tbody = document.getElementById('cuerpoTabla');
    tbody.innerHTML = '';
    
    datosPagina.forEach((registro, index) => {
      const numeroGlobal = inicio + index + 1;
      const fila = document.createElement('tr');
      fila.innerHTML = `
        <td>${numeroGlobal}</td>
        <td>${registro.UNIDAD || '-'}</td>
        <td>${registro.CODIGO || '-'}</td>
        <td>${formatearFecha(registro.FECHA)}</td>
        <td>${registro.FATAL || '-'}</td>
        <td>
          <div class="acciones">
            <button class="btn-icono btn-ver" onclick="verDetalle(${inicio + index})" title="Ver detalle">üëÅ</button>
            <button class="btn-icono btn-registrar" onclick="registrarDetalle(${inicio + index})" title="Registrar detalle">üìù</button>
            <button class="btn-icono btn-editar" onclick="editarRegistro(${inicio + index})" title="Editar">‚úèÔ∏è</button>
            <button class="btn-icono btn-eliminar" onclick="eliminarRegistro(${inicio + index})" title="Eliminar">üóëÔ∏è</button>
          </div>
        </td>
      `;
      tbody.appendChild(fila);
    });
    
    actualizarPaginacion();
    actualizarInfoRegistros();
  }

  function formatearFecha(fecha) {
    if (!fecha) return '-';
    
    // Si es un n√∫mero de serie de Excel
    if (typeof fecha === 'number') {
      const fechaExcel = new Date((fecha - 25569) * 86400 * 1000);
      return fechaExcel.toLocaleDateString('es-PE');
    }
    
    // Si ya es una fecha v√°lida
    return new Date(fecha).toLocaleDateString('es-PE');
  }

  function actualizarPaginacion() {
    const totalPaginas = Math.ceil(datosFiltrados.length / registrosPorPagina);
    const paginacion = document.getElementById('paginacion');
    paginacion.innerHTML = '';
    
    // Bot√≥n Anterior
    const btnAnterior = document.createElement('button');
    btnAnterior.textContent = '‚Üê Anterior';
    btnAnterior.disabled = paginaActual === 1;
    btnAnterior.onclick = () => cambiarPagina(paginaActual - 1);
    paginacion.appendChild(btnAnterior);
    
    // P√°ginas
    const inicio = Math.max(1, paginaActual - 2);
    const fin = Math.min(totalPaginas, paginaActual + 2);
    
    for (let i = inicio; i <= fin; i++) {
      const btnPagina = document.createElement('button');
      btnPagina.textContent = i;
      btnPagina.className = i === paginaActual ? 'activo' : '';
      btnPagina.onclick = () => cambiarPagina(i);
      paginacion.appendChild(btnPagina);
    }
    
    // Bot√≥n Siguiente
    const btnSiguiente = document.createElement('button');
    btnSiguiente.textContent = 'Siguiente ‚Üí';
    btnSiguiente.disabled = paginaActual === totalPaginas;
    btnSiguiente.onclick = () => cambiarPagina(paginaActual + 1);
    paginacion.appendChild(btnSiguiente);
  }

  function cambiarPagina(nuevaPagina) {
    paginaActual = nuevaPagina;
    actualizarTabla();
  }

  function actualizarInfoRegistros() {
    const info = document.getElementById('infoRegistros');
    info.textContent = `Mostrando ${datosFiltrados.length} registros`;
  }

  // Buscador
  document.getElementById('buscar').addEventListener('input', function(e) {
    const termino = e.target.value.toLowerCase();
    
    datosFiltrados = datosCompletos.filter(registro => {
      const unidad = (registro.UNIDAD || '').toString().toLowerCase();
      const codigo = (registro.CODIGO || '').toString().toLowerCase();
      const fecha = formatearFecha(registro.FECHA).toLowerCase();
      
      return unidad.includes(termino) || 
             codigo.includes(termino) || 
             fecha.includes(termino);
    });
    
    paginaActual = 1;
    actualizarTabla();
  });

  // Funciones de acci√≥n
  function verDetalle(index) {
    const registro = datosFiltrados[index];
    alert('Ver detalle de: ' + registro.CODIGO + '\n\nEsta funcionalidad se implementar√° pr√≥ximamente.');
  }

  function registrarDetalle(index) {
    const registro = datosFiltrados[index];
    alert('Registrar detalle para: ' + registro.CODIGO + '\n\nEsta funcionalidad se implementar√° pr√≥ximamente.');
  }

  function editarRegistro(index) {
    const registro = datosFiltrados[index];
    alert('Editar registro: ' + registro.CODIGO + '\n\nEsta funcionalidad se implementar√° pr√≥ximamente.');
  }

  function eliminarRegistro(index) {
    const registro = datosFiltrados[index];
    if (confirm('¬øEst√°s seguro de eliminar el registro ' + registro.CODIGO + '?')) {
      const URL_APPS_SCRIPT = 'TU_URL_DE_WEB_APP_AQUI';
      
      fetch(URL_APPS_SCRIPT, {
        method: 'POST',
        body: JSON.stringify({
          action: 'eliminarJIAT',
          codigo: registro.CODIGO
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Registro eliminado exitosamente');
          cargarDatosExcel(); // Recargar datos
        } else {
          alert('Error al eliminar: ' + data.error);
        }
      })
      .catch(error => {
        alert('Error al eliminar el registro');
        console.error(error);
      });
    }
  }

  function nuevoRegistro() {
    alert('Abrir formulario de nuevo registro\n\nEsta funcionalidad se implementar√° pr√≥ximamente.');
  }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JIAT - Información de las Juntas de Investigación de Accidentes Terrestres</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: Arial, sans-serif;
    background-color: #f4f6fa;
    color: #222;
    padding: 20px;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  h1 {
    color: #002147;
    margin-bottom: 30px;
    font-size: 2rem;
  }

  /* Botón flotante */
  .btn-flotante {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    background-color: #0056A6;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 2rem;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transition: all 0.3s;
    z-index: 1000;
  }

  .btn-flotante:hover {
    background-color: #003366;
    transform: scale(1.1);
  }

  /* Tabla */
  .tabla-container {
    overflow-x: auto;
    margin-bottom: 20px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  thead {
    background-color: #002147;
    color: white;
  }

  th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }

  th {
    font-weight: 600;
    position: sticky;
    top: 0;
  }

  tbody tr:hover {
    background-color: #f0f4ff;
  }

  /* Iconos de acción */
  .acciones {
    display: flex;
    gap: 10px;
  }

  .btn-icono {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9rem;
  }

  .btn-ver {
    background-color: #17a2b8;
    color: white;
  }

  .btn-ver:hover {
    background-color: #138496;
  }

  .btn-registrar {
    background-color: #28a745;
    color: white;
  }

  .btn-registrar:hover {
    background-color: #218838;
  }

  .btn-editar {
    background-color: #ffc107;
    color: white;
  }

  .btn-editar:hover {
    background-color: #e0a800;
  }

  .btn-eliminar {
    background-color: #dc3545;
    color: white;
  }

  .btn-eliminar:hover {
    background-color: #c82333;
  }

  /* Paginación */
  .paginacion {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 20px;
  }

  .paginacion button {
    padding: 8px 16px;
    border: 1px solid #0056A6;
    background-color: white;
    color: #0056A6;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.3s;
  }

  .paginacion button:hover:not(:disabled) {
    background-color: #0056A6;
    color: white;
  }

  .paginacion button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .paginacion .activo {
    background-color: #0056A6;
    color: white;
  }

  .paginacion span {
    color: #666;
  }

  /* Buscador */
  .buscador {
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .buscador input {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
  }

  .info-registros {
    color: #666;
    font-size: 0.9rem;
  }

  /* Loading */
  .loading {
    text-align: center;
    padding: 40px;
    color: #0056A6;
    font-size: 1.2rem;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.3s;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .modal-content {
    background-color: #fefefe;
    margin: 3% auto;
    padding: 0;
    border-radius: 8px;
    width: 90%;
    max-width: 700px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    animation: slideDown 0.3s;
  }

  @keyframes slideDown {
    from {
      transform: translateY(-50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .modal-header {
    background-color: #002147;
    color: white;
    padding: 20px;
    border-radius: 8px 8px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
  }

  .close {
    color: white;
    font-size: 2rem;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s;
  }

  .close:hover {
    color: #ddd;
  }

  .modal-body {
    padding: 30px;
    max-height: 70vh;
    overflow-y: auto;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    font-family: Arial, sans-serif;
  }

  .form-group textarea {
    resize: vertical;
    min-height: 100px;
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #0056A6;
    box-shadow: 0 0 5px rgba(0,86,166,0.3);
  }

  .involucrados-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .involucrado-item {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .involucrado-item input {
    flex: 1;
  }

  .btn-agregar-involucrado {
    margin-top: 10px;
    padding: 8px 16px;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
  }

  .btn-agregar-involucrado:hover {
    background-color: #218838;
  }

  .btn-quitar {
    padding: 8px 12px;
    background-color: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  .btn-quitar:hover {
    background-color: #c82333;
  }

  .modal-footer {
    padding: 20px 30px;
    border-top: 1px solid #ddd;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }

  .btn-guardar,
  .btn-cancelar {
    padding: 10px 24px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.3s;
  }

  .btn-guardar {
    background-color: #0056A6;
    color: white;
  }

  .btn-guardar:hover {
    background-color: #003366;
  }

  .btn-guardar:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }

  .btn-cancelar {
    background-color: #6c757d;
    color: white;
  }

  .btn-cancelar:hover {
    background-color: #5a6268;
  }

  .required {
    color: red;
  }

  /* Overlay de carga */
  .overlay-carga {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 3000;
    justify-content: center;
    align-items: center;
  }

  .overlay-content {
    background-color: white;
    padding: 30px 50px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }

  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #0056A6;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .overlay-content p {
    margin: 0;
    font-size: 1.1rem;
    color: #333;
    font-weight: 500;
  }
</style>
</head>
<body>

<div class="container">
  <h1>JIAT - Información de las Juntas de Investigación de Accidentes Terrestres</h1>
  
  <div class="buscador">
    <input type="text" id="buscar" placeholder="Buscar por unidad, código o fecha...">
    <span class="info-registros" id="infoRegistros"></span>
  </div>

  <div class="tabla-container">
    <div class="loading" id="loading">Cargando datos...</div>
    <table id="tablaJIAT" style="display:none;">
      <thead>
        <tr>
          <th>N°</th>
          <th>UNIDAD</th>
          <th>CÓDIGO</th>
          <th>FECHA</th>
          <th>FATAL</th>
          <th>ACCIONES</th>
        </tr>
      </thead>
      <tbody id="cuerpoTabla">
      </tbody>
    </table>
  </div>

  <div class="paginacion" id="paginacion" style="display:none;"></div>
</div>

<button class="btn-flotante" onclick="nuevoRegistro()" title="Nuevo Registro">+</button>

<!-- Overlay de carga -->
<div id="overlayGlobal" class="overlay-carga">
  <div class="overlay-content">
    <div class="spinner"></div>
    <p id="mensajeCarga">Guardando registro...</p>
  </div>
</div>

<!-- Modal Nuevo Registro -->
<div id="modalNuevo" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Nuevo Registro JIAT</h2>
      <span class="close" onclick="cerrarModal()">&times;</span>
    </div>
    <div class="modal-body">
      <form id="formNuevo">
        <div class="form-group">
          <label>Número <span class="required">*</span></label>
          <input type="number" id="numero" min="1" required>
        </div>

        <div class="form-group">
          <label>Periodo <span class="required">*</span></label>
          <select id="periodo" required onchange="actualizarRangoFechas()">
            <option value="">Seleccione un año</option>
          </select>
        </div>

        <div class="form-group">
          <label>Fecha <span class="required">*</span></label>
          <input type="date" id="fecha" required>
        </div>

        <div class="form-group">
          <label>Lugar <span class="required">*</span></label>
          <input type="text" id="lugar" required>
        </div>

        <div class="form-group">
          <label>Involucrado(s) <span class="required">*</span></label>
          <div id="involucradosContainer" class="involucrados-container">
            <div class="involucrado-item">
              <input type="text" class="involucrado-input" placeholder="Nombre del involucrado" required>
            </div>
          </div>
          <button type="button" class="btn-agregar-involucrado" onclick="agregarInvolucrado()">+ Agregar Involucrado</button>
        </div>

        <div class="form-group">
          <label>Fatal <span class="required">*</span></label>
          <select id="fatal" required>
            <option value="">Seleccione</option>
            <option value="SÍ">SÍ</option>
            <option value="NO">NO</option>
          </select>
        </div>

        <div class="form-group">
          <label>Cant. Fatalidades <span class="required">*</span></label>
          <input type="number" id="cantfall" min="0" value="0" required>
        </div>

        <div class="form-group">
          <label>Descripción del Accidente <span class="required">*</span></label>
          <textarea id="descripcion" required></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-cancelar" onclick="cerrarModal()">Cancelar</button>
      <button type="button" class="btn-guardar" onclick="guardarRegistro()" id="btnGuardar">Guardar</button>
    </div>
  </div>
</div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbxIeRDr8R2JAQ39AlFW4f8hOrhMmvaJvuAOGwfOurjmUKn57xdXQ8t-70WweSkAorwy/exec';
  
  let datosCompletos = [];
  let datosFiltrados = [];
  let paginaActual = 1;
  const registrosPorPagina = 10;

  // Obtener datos del usuario desde localStorage
  const usuario = localStorage.getItem("usuario") || "";
  const unidad = localStorage.getItem("unidad") || "";

  // Validar sesión
  if (!usuario) {
    window.location.replace("login.html");
  }

  // Cargar años en el selector de periodo
  window.onload = function() {
    cargarPeriodos();
    cargarDatosExcel();
  };

  function cargarPeriodos() {
    const select = document.getElementById('periodo');
    const añoActual = new Date().getFullYear();
    
    for (let i = añoActual; i >= añoActual - 30; i--) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = i;
      select.appendChild(option);
    }
  }

  function actualizarRangoFechas() {
    const periodo = document.getElementById('periodo').value;
    const inputFecha = document.getElementById('fecha');
    
    if (periodo) {
      inputFecha.min = `${periodo}-01-01`;
      inputFecha.max = `${periodo}-12-31`;
      inputFecha.value = '';
    }
  }

  function agregarInvolucrado() {
    const container = document.getElementById('involucradosContainer');
    const nuevoItem = document.createElement('div');
    nuevoItem.className = 'involucrado-item';
    nuevoItem.innerHTML = `
      <input type="text" class="involucrado-input" placeholder="Nombre del involucrado" required>
      <button type="button" class="btn-quitar" onclick="quitarInvolucrado(this)">×</button>
    `;
    container.appendChild(nuevoItem);
  }

  function quitarInvolucrado(btn) {
    btn.parentElement.remove();
  }

  async function cargarDatosExcel() {
    try {
      const response = await fetch(API_URL + '?action=obtenerJIAT');
      const datos = await response.json();
      
      if (datos.error) {
        throw new Error(datos.error);
      }
      
      // Ordenar por fecha de más reciente a más antigua
      datosCompletos = datos.sort((a, b) => {
        const fechaA = convertirFecha(a.FECHA);
        const fechaB = convertirFecha(b.FECHA);
        return fechaB - fechaA; // Descendente (más reciente primero)
      });
      
      datosFiltrados = [...datosCompletos];
      
      document.getElementById('loading').style.display = 'none';
      document.getElementById('tablaJIAT').style.display = 'table';
      document.getElementById('paginacion').style.display = 'flex';
      
      actualizarTabla();
    } catch (error) {
      console.error('Error al cargar los datos:', error);
      document.getElementById('loading').innerHTML = 
        'Error al cargar los datos. Por favor, verifica la conexión.';
    }
  }

  function convertirFecha(fechaStr) {
    if (!fechaStr) return new Date(0);
    
    // Si viene en formato dd/MM/yyyy
    if (fechaStr.includes('/')) {
      const partes = fechaStr.split('/');
      if (partes.length === 3) {
        return new Date(partes[2], partes[1] - 1, partes[0]);
      }
    }
    
    // Si viene en otro formato, intentar parsearlo directamente
    return new Date(fechaStr);
  }

  function actualizarTabla() {
    const inicio = (paginaActual - 1) * registrosPorPagina;
    const fin = inicio + registrosPorPagina;
    const datosPagina = datosFiltrados.slice(inicio, fin);
    
    const tbody = document.getElementById('cuerpoTabla');
    tbody.innerHTML = '';
    
    datosPagina.forEach((registro, index) => {
      const numeroGlobal = inicio + index + 1;
      const fila = document.createElement('tr');
      fila.innerHTML = `
        <td>${numeroGlobal}</td>
        <td>${registro.UNIDAD || '-'}</td>
        <td>${registro.CODIGO || '-'}</td>
        <td>${registro.FECHA || '-'}</td>
        <td>${registro.FATAL || '-'}</td>
        <td>
          <div class="acciones">
            <button class="btn-icono btn-ver" onclick="verDetalle(${inicio + index})" title="Ver detalle">👁</button>
            <button class="btn-icono btn-editar" onclick="editarRegistro(${inicio + index})" title="Editar">✏️</button>
            <button class="btn-icono btn-eliminar" onclick="eliminarRegistro(${inicio + index})" title="Eliminar">🗑️</button>
          </div>
        </td>
      `;
      tbody.appendChild(fila);
    });
    
    actualizarPaginacion();
    actualizarInfoRegistros();
  }

  function actualizarPaginacion() {
    const totalPaginas = Math.ceil(datosFiltrados.length / registrosPorPagina);
    const paginacion = document.getElementById('paginacion');
    paginacion.innerHTML = '';
    
    const btnAnterior = document.createElement('button');
    btnAnterior.textContent = '← Anterior';
    btnAnterior.disabled = paginaActual === 1;
    btnAnterior.onclick = () => cambiarPagina(paginaActual - 1);
    paginacion.appendChild(btnAnterior);
    
    const inicio = Math.max(1, paginaActual - 2);
    const fin = Math.min(totalPaginas, paginaActual + 2);
    
    for (let i = inicio; i <= fin; i++) {
      const btnPagina = document.createElement('button');
      btnPagina.textContent = i;
      btnPagina.className = i === paginaActual ? 'activo' : '';
      btnPagina.onclick = () => cambiarPagina(i);
      paginacion.appendChild(btnPagina);
    }
    
    const btnSiguiente = document.createElement('button');
    btnSiguiente.textContent = 'Siguiente →';
    btnSiguiente.disabled = paginaActual === totalPaginas;
    btnSiguiente.onclick = () => cambiarPagina(paginaActual + 1);
    paginacion.appendChild(btnSiguiente);
  }

  function cambiarPagina(nuevaPagina) {
    paginaActual = nuevaPagina;
    actualizarTabla();
  }

  function actualizarInfoRegistros() {
    const info = document.getElementById('infoRegistros');
    info.textContent = `Mostrando ${datosFiltrados.length} registros`;
  }

  document.getElementById('buscar').addEventListener('input', function(e) {
    const termino = e.target.value.toLowerCase();
    
    datosFiltrados = datosCompletos.filter(registro => {
      const unidad = (registro.UNIDAD || '').toString().toLowerCase();
      const codigo = (registro.CODIGO || '').toString().toLowerCase();
      const fecha = (registro.FECHA || '').toString().toLowerCase();
      
      return unidad.includes(termino) || 
             codigo.includes(termino) || 
             fecha.includes(termino);
    });
    
    paginaActual = 1;
    actualizarTabla();
  });

  function nuevoRegistro() {
    document.getElementById('modalNuevo').style.display = 'block';
    document.getElementById('formNuevo').reset();
    
    // Limpiar involucrados extra
    const container = document.getElementById('involucradosContainer');
    container.innerHTML = `
      <div class="involucrado-item">
        <input type="text" class="involucrado-input" placeholder="Nombre del involucrado" required>
      </div>
    `;
  }

  function cerrarModal() {
    document.getElementById('modalNuevo').style.display = 'none';
  }

  function mostrarOverlay(mensaje) {
    document.getElementById('mensajeCarga').textContent = mensaje;
    document.getElementById('overlayGlobal').style.display = 'flex';
  }

  function ocultarOverlay() {
    document.getElementById('overlayGlobal').style.display = 'none';
  }

  window.onclick = function(event) {
    const modal = document.getElementById('modalNuevo');
    if (event.target == modal) {
      cerrarModal();
    }
  }

  async function guardarRegistro() {
    const form = document.getElementById('formNuevo');
    
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }

    const btnGuardar = document.getElementById('btnGuardar');
    btnGuardar.disabled = true;
    btnGuardar.textContent = 'Guardando...';

    // Mostrar overlay
    mostrarOverlay('Guardando registro...');

    try {
      const numero = document.getElementById('numero').value;
      const periodo = document.getElementById('periodo').value;
      const fecha = document.getElementById('fecha').value;
      const lugar = document.getElementById('lugar').value;
      const fatal = document.getElementById('fatal').value;
      const cantfall = document.getElementById('cantfall').value;
      const descripcion = document.getElementById('descripcion').value;

      // Obtener todos los involucrados
      const involucradosInputs = document.querySelectorAll('.involucrado-input');
      const involucrados = Array.from(involucradosInputs)
        .map(input => input.value.trim())
        .filter(val => val !== '')
        .join(', ');

      if (!involucrados) {
        ocultarOverlay();
        alert('Debe agregar al menos un involucrado');
        btnGuardar.disabled = false;
        btnGuardar.textContent = 'Guardar';
        return;
      }

      // Generar código automático
      const numeroFormateado = numero.padStart(3, '0');
      const codigo = `JIAT-${numeroFormateado}-${periodo}`;

      const datos = {
        action: 'crearJIAT',
        USUARIOREG: usuario,
        TIPO: 'JIAT',
        NUMERO: numero,
        PERIODO: periodo,
        CODIGO: codigo,
        UNIDAD: unidad,
        FECHA: fecha,
        LUGAR: lugar,
        INVOLUCRADO: involucrados,
        FATAL: fatal,
        CANTFALL: cantfall,
        DESCRIPCION: descripcion
      };

      const response = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify(datos)
      });

      const result = await response.json();

      if (result.success) {
        mostrarOverlay('Registro guardado. Actualizando tabla...');
        
        // Esperar un momento antes de recargar
        await cargarDatosExcel();
        
        ocultarOverlay();
        alert('Registro creado exitosamente');
        cerrarModal();
      } else {
        ocultarOverlay();
        alert('Error al crear el registro: ' + result.error);
      }
    } catch (error) {
      console.error('Error:', error);
      ocultarOverlay();
      alert('Error al guardar el registro');
    } finally {
      btnGuardar.disabled = false;
      btnGuardar.textContent = 'Guardar';
    }
  }

  function verDetalle(index) {
    const registro = datosFiltrados[index];
    alert('Ver detalle de: ' + registro.CODIGO + '\n\nEsta funcionalidad se implementará próximamente.');
  }

  function editarRegistro(index) {
    const registro = datosFiltrados[index];
    alert('Editar registro: ' + registro.CODIGO + '\n\nEsta funcionalidad se implementará próximamente.');
  }

  function eliminarRegistro(index) {
    const registro = datosFiltrados[index];
    if (confirm('¿Estás seguro de eliminar el registro ' + registro.CODIGO + '?')) {
      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'eliminarJIAT',
          CODIGO: registro.CODIGO
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Registro eliminado exitosamente');
          cargarDatosExcel();
        } else {
          alert('Error al eliminar: ' + data.error);
        }
      })
      .catch(error => {
        alert('Error al eliminar el registro');
        console.error(error);
      });
    }
  }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JIAT - Información de las Juntas de Investigación de Accidentes Terrestres</title>
<link rel="stylesheet" href="css/jiat.css">
</head>
<body>

<div class="container">
  <h1>JIAT - Información de las Juntas de Investigación de Accidentes Terrestres</h1>
  
  <div class="buscador">
    <input type="text" id="buscar" placeholder="Buscar por unidad, código o fecha...">
    <span class="info-registros" id="infoRegistros"></span>
  </div>

  <div class="tabla-container">
    <div class="loading" id="loading">Cargando datos...</div>
    <table id="tablaJIAT" style="display:none;">
      <thead>
        <tr>
          <th>N°</th>
          <th>UNIDAD</th>
          <th>CÓDIGO</th>
          <th>FECHA</th>
          <th>FATAL</th>
          <th>ACCIONES</th>
        </tr>
      </thead>
      <tbody id="cuerpoTabla"></tbody>
    </table>
  </div>

  <div class="paginacion" id="paginacion" style="display:none;"></div>
</div>

<button class="btn-flotante" onclick="nuevoRegistro()" title="Nuevo Registro">+</button>

<div id="overlayGlobal" class="overlay-carga">
  <div class="overlay-content">
    <div class="spinner"></div>
    <p id="mensajeCarga">Guardando registro...</p>
  </div>
</div>

<!-- MODAL NUEVO REGISTRO JIAT -->
<div id="modalNuevo" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Nuevo Registro JIAT</h2>
      <span class="close" onclick="cerrarModal()">&times;</span>
    </div>
    <div class="modal-body">
      <form id="formNuevo">
        <div class="seccion" id="seccionCabecera">
          <div class="seccion-titulo">📋 Paso 1: Datos Principales del Accidente</div>
          
          <div class="mensaje-info">
            💡 <strong>Importante:</strong> Primero guarde los datos principales. Luego podrá agregar conclusiones, causas y recomendaciones.
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Número <span class="required">*</span></label>
              <input type="number" id="numero" min="1" required>
            </div>
            <div class="form-group">
              <label>Periodo <span class="required">*</span></label>
              <select id="periodo" required onchange="actualizarRangoFechas()">
                <option value="">Seleccione un año</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Fecha <span class="required">*</span></label>
              <input type="date" id="fecha" required>
            </div>
            <div class="form-group">
              <label>Lugar <span class="required">*</span></label>
              <input type="text" id="lugar" required>
            </div>
          </div>

          <div class="form-group">
            <label>Involucrado(s) <span class="required">*</span></label>
            <div id="involucradosContainer" class="involucrados-container">
              <div class="involucrado-item">
                <input type="text" class="involucrado-input" placeholder="Nombre del involucrado" required>
              </div>
            </div>
            <button type="button" class="btn-agregar-involucrado" onclick="agregarInvolucrado()">+ Agregar Involucrado</button>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Fatal <span class="required">*</span></label>
              <select id="fatal" required>
                <option value="">Seleccione</option>
                <option value="SÍ">SÍ</option>
                <option value="NO">NO</option>
              </select>
            </div>
            <div class="form-group">
              <label>Cant. Fatalidades <span class="required">*</span></label>
              <input type="number" id="cantfall" min="0" value="0" required>
            </div>
          </div>

          <div class="form-group">
            <label>Descripción del Accidente <span class="required">*</span></label>
            <textarea id="descripcion" required></textarea>
          </div>

          <button type="button" class="btn-guardar-cabecera" onclick="guardarCabecera()" id="btnGuardarCabecera">
            💾 Guardar y Continuar
          </button>
        </div>

        <div class="seccion bloqueada" id="seccionDetalles">
          <div class="seccion-titulo">📝 Paso 2: Detalles - Conclusiones, Causas y Recomendaciones</div>
          
          <div class="mensaje-info" id="mensajeBloqueo">
            🔒 Esta sección se habilitará después de guardar los datos principales.
          </div>
          
          <div id="detallesContainer"></div>
          
          <button type="button" class="btn-agregar-detalle" onclick="agregarDetalle()" id="btnAgregarDetalle" disabled>
            + Agregar Conclusión / Causa / Recomendación
          </button>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-cerrar" onclick="cerrarModalCompleto()">Cerrar y Finalizar</button>
    </div>
  </div>
</div>

<!-- MODAL ACCIONES TOMADAS -->
<div id="modalAcciones" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h2>Registrar Acciones Tomadas</h2>
      <span class="close" onclick="cerrarModalAcciones()">&times;</span>
    </div>
    <div class="modal-body">
      
      <div class="seccion info-jiat">
        <div class="seccion-titulo">📋 Información del JIAT</div>
        
        <div class="info-grid">
          <div class="info-item"><strong>Código:</strong><span id="infoCodigo">-</span></div>
          <div class="info-item"><strong>Fecha:</strong><span id="infoFecha">-</span></div>
          <div class="info-item"><strong>Unidad:</strong><span id="infoUnidad">-</span></div>
          <div class="info-item"><strong>Lugar:</strong><span id="infoLugar">-</span></div>
          <div class="info-item"><strong>Involucrado(s):</strong><span id="infoInvolucrado">-</span></div>
          <div class="info-item"><strong>Fatal:</strong><span id="infoFatal">-</span></div>
        </div>

        <div class="info-descripcion">
          <strong>Descripción del Accidente:</strong>
          <p id="infoDescripcion">-</p>
        </div>

        <div id="detallesConclusiones" style="display:none;">
          <h4>📌 Conclusiones:</h4>
          <ul id="listaConclusiones"></ul>
        </div>

        <div id="detallesCausas" style="display:none;">
          <h4>⚠️ Causas:</h4>
          <ul id="listaCausas"></ul>
        </div>

        <div id="detallesRecomendaciones" style="display:none;">
          <h4>💡 Recomendaciones:</h4>
          <ul id="listaRecomendaciones"></ul>
        </div>
      </div>

      <div class="seccion" id="seccionAccionesRegistradas" style="display:none;">
        <div class="seccion-titulo">✅ Acciones Tomadas Previamente Registradas</div>
        <div id="listaAccionesRegistradas"></div>
      </div>

      <div class="seccion">
        <div class="seccion-titulo">➕ Registrar Nueva Acción Tomada</div>
        <div id="accionesContainer"></div>
        <button type="button" class="btn-agregar-detalle" onclick="agregarAccionTomada()">
          + Agregar Acción Tomada
        </button>
      </div>

    </div>
    <div class="modal-footer">
      <button type="button" class="btn-cerrar" onclick="cerrarModalAcciones()">Cerrar</button>
    </div>
  </div>
</div>

<!-- MODAL VER DETALLE -->
<div id="modalVerDetalle" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h2>👁 Ver Detalle Completo del JIAT</h2>
      <span class="close" onclick="cerrarModalVerDetalle()">&times;</span>
    </div>
    <div class="modal-body">
      
      <div class="seccion info-jiat">
        <div class="seccion-titulo">📋 Información del JIAT</div>
        <div class="info-grid">
          <div class="info-item"><strong>Código:</strong><span id="verCodigo">-</span></div>
          <div class="info-item"><strong>Fecha:</strong><span id="verFecha">-</span></div>
          <div class="info-item"><strong>Unidad:</strong><span id="verUnidad">-</span></div>
          <div class="info-item"><strong>Lugar:</strong><span id="verLugar">-</span></div>
          <div class="info-item"><strong>Involucrado(s):</strong><span id="verInvolucrado">-</span></div>
          <div class="info-item"><strong>Fatal:</strong><span id="verFatal">-</span></div>
        </div>
        <div class="info-descripcion">
          <strong>Descripción del Accidente:</strong>
          <p id="verDescripcion">-</p>
        </div>
      </div>

      <div class="seccion" id="verSeccionConclusiones" style="display:none;">
        <div class="seccion-titulo">📌 Conclusiones</div>
        <div id="verListaConclusiones"></div>
      </div>

      <div class="seccion" id="verSeccionCausas" style="display:none;">
        <div class="seccion-titulo">⚠️ Causas</div>
        <div id="verListaCausas"></div>
      </div>

      <div class="seccion" id="verSeccionAcciones" style="display:none;">
        <div class="seccion-titulo">✅ Acciones Tomadas</div>
        <div id="verListaAcciones"></div>
      </div>

    </div>
    <div class="modal-footer">
      <button type="button" class="btn-cerrar" onclick="cerrarModalVerDetalle()">Cerrar</button>
    </div>
  </div>
</div>

<!-- MODAL EDITAR - SIN EDICIÓN DE NÚMERO Y PERIODO -->
<div id="modalEditar" class="modal">
  <div class="modal-content" style="max-width: 1000px;">
    <div class="modal-header">
      <h2>✏️ Editar JIAT</h2>
      <span class="close" onclick="cerrarModalEditar()">&times;</span>
    </div>
    <div class="modal-body">
      
      <!-- PASO 1: EDITAR CABECERA -->
      <div class="seccion" id="editSeccionCabecera">
        <div class="seccion-titulo">📋 Paso 1: Editar Datos Principales</div>
        
        <div class="mensaje-info">
          ℹ️ <strong>Nota:</strong> El Número y Periodo no se pueden modificar para mantener la integridad de los datos.
        </div>
        
        <input type="hidden" id="editCodigoActual">
        <div id="editAdvertenciaCodigo" class="mensaje-advertencia" style="display:none;">
          <strong>⚠️ ATENCIÓN</strong>
          <p id="editTextoAdvertencia"></p>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Número (solo lectura)</label>
            <input type="number" id="editNumero" min="1" required readonly style="background-color: #f0f0f0; cursor: not-allowed;">
          </div>
          <div class="form-group">
            <label>Periodo (solo lectura)</label>
            <select id="editPeriodo" required disabled style="background-color: #f0f0f0; cursor: not-allowed;">
              <option value="">Seleccione un año</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Fecha <span class="required">*</span></label>
            <input type="date" id="editFecha" required>
          </div>
          <div class="form-group">
            <label>Lugar <span class="required">*</span></label>
            <input type="text" id="editLugar" required>
          </div>
        </div>

        <div class="form-group">
          <label>Involucrado(s) <span class="required">*</span></label>
          <textarea id="editInvolucrado" required rows="2"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Fatal <span class="required">*</span></label>
            <select id="editFatal" required>
              <option value="">Seleccione</option>
              <option value="SÍ">SÍ</option>
              <option value="NO">NO</option>
            </select>
          </div>
          <div class="form-group">
            <label>Cant. Fatalidades <span class="required">*</span></label>
            <input type="number" id="editCantfall" min="0" required>
          </div>
        </div>

        <div class="form-group">
          <label>Descripción del Accidente <span class="required">*</span></label>
          <textarea id="editDescripcion" required rows="4"></textarea>
        </div>

        <button type="button" class="btn-guardar-cabecera" onclick="guardarCabeceraEdicion()" id="btnGuardarCabeceraEdit">
          💾 Guardar y Continuar
        </button>
      </div>

      <!-- PASO 2: EDITAR DETALLES (BLOQUEADO HASTA GUARDAR CABECERA) -->
      <div class="seccion bloqueada" id="editSeccionDetalles">
        <div class="seccion-titulo">📝 Paso 2: Editar Detalles (Conclusiones, Causas, Recomendaciones)</div>
        
        <div class="mensaje-info" id="editMensajeBloqueo">
          🔒 Esta sección se habilitará después de guardar los cambios en la cabecera.
        </div>
        
        <div id="editDetallesContainer"></div>
        
        <button type="button" class="btn-agregar-detalle" onclick="agregarDetalleEdicion()" id="btnAgregarDetalleEdit" disabled>
          + Agregar Nuevo Detalle
        </button>
      </div>

      <!-- PASO 3: EDITAR ACCIONES (BLOQUEADO HASTA GUARDAR CABECERA) -->
      <div class="seccion bloqueada" id="editSeccionAcciones">
        <div class="seccion-titulo">✅ Paso 3: Editar Acciones Tomadas</div>
        <div id="editAccionesContainer"></div>
      </div>

    </div>
    <div class="modal-footer">
      <button type="button" class="btn-cerrar" onclick="cerrarModalEditar()">Cerrar y Finalizar</button>
    </div>
  </div>
</div>

<script src="js/jiat.js"></script>
</body>
</html>

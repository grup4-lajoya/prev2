<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Accidentes - FAP</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background-color: #f4f6fa; color: #222; }
    nav { background-color: #002147; color: #fff; display: flex; justify-content: center; }
    nav ul { list-style: none; margin: 0; padding: 0; display: flex; }
    nav a { display: block; padding: 16px 24px; color: #fff; text-decoration: none; }
    nav a:hover { background: #003366; }
    nav a.active { background: #0056A6; }
    #contenido { padding: 20px; }
    iframe { width: 100%; height: calc(100vh - 90px); border: none; display: none; }
    form { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 12px; }
    form input { width: 100%; padding: 8px; margin: 6px 0 16px; }
    form button { background: #0056A6; color: #fff; padding: 12px; border: none; width: 100%; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #0056A6; color: white; }
    button.action { padding: 4px 8px; margin: 2px; cursor: pointer; }
    #mensaje { margin-top: 10px; text-align: center; font-weight: bold; }
    #filtros { margin: 15px 0; }
    #filtros input { padding: 6px; margin-right: 10px; }
    #exportar { background: green; color: white; padding: 8px 16px; border: none; cursor: pointer; }
  </style>
</head>
<body onload="mostrar('dashboard')">

  <nav>
    <ul>
      <li><a href="#" id="menu-dashboard" onclick="mostrar('dashboard')">üìä Panorama</a></li>
      <li><a href="#" id="menu-form1" onclick="mostrar('form1')">üìù Registrar</a></li>
      <li><a href="#" id="menu-tabla" onclick="mostrar('tabla')">üìÇ Consultar</a></li>
    </ul>
  </nav>

  <div id="contenido">
    <!-- Dashboard -->
    <iframe id="dashboard" 
      src="https://lookerstudio.google.com/embed/reporting/602a617d-1555-48d5-a104-342f3194e256/page/ddmZF&rm=minimal">
    </iframe>

    <!-- Formulario -->
    <div id="form1" style="display:none;">
      <h2>Registro Accidentes / Incidentes</h2>
      <form id="formAccidente">
        <input type="hidden" name="row">
        <label>Pa√≠s:</label><input type="text" name="pais" required>
        <label>Regi√≥n:</label><input type="text" name="region">
        <label>Fecha:</label><input type="date" name="fecha" required>
        <label>A√±o:</label><input type="number" name="anio">
        <label>Tipo:</label><input type="text" name="tipo">
        <label>Cant. Tipo:</label><input type="number" name="cant_tipo">
        <label>Cant. Fall:</label><input type="number" name="cant_fall">
        <label>Factor:</label><input type="text" name="factor">
        <label>Tipo Ocurrencia:</label><input type="text" name="tipo_ocurrencia">
        <label>Tipo Aeronave:</label><input type="text" name="tipo_aeronave">
        <label>Nacionalidad:</label><input type="text" name="nacionalidad">
        <label>Matr√≠cula:</label><input type="text" name="matricula">
        <label>Tipo Operaci√≥n:</label><input type="text" name="tipo_operacion">
        <label>Fase:</label><input type="text" name="fase">
        <label>Da√±o:</label><input type="text" name="danio">
        <label>Lesi√≥n:</label><input type="text" name="lesion">
        <label>Unidad:</label><input type="text" name="unidad">
        <label>Prueba:</label><input type="text" name="prueba">
        <button type="submit">Guardar</button>
      </form>
      <p id="mensaje"></p>
    </div>

    <!-- Tabla -->
    <div id="tabla" style="display:none;">
      <h2>Consulta Accidentes</h2>
      <div id="filtros">
        <label>Filtrar por Pa√≠s:</label>
        <input type="text" id="filtroPais" onkeyup="filtrar()">
        <label>Filtrar por A√±o:</label>
        <input type="text" id="filtroAnio" onkeyup="filtrar()">
        <button id="exportar" onclick="exportarCSV()">‚¨áÔ∏è Exportar CSV</button>
      </div>
      <table id="tablaDatos">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbw4CymPHjYlhWwSx29g-Z9hNU5dRg9yYP6S0NCAGf2y-o87L5mdyzWzjQM8m4NWudQY/exec";

function mostrar(id) {
  document.querySelectorAll("#contenido iframe, #contenido > div").forEach(el => el.style.display = "none");
  document.getElementById(id).style.display = "block";
  document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
  document.getElementById('menu-' + id).classList.add('active');
  if(id==="tabla"){ cargarDatos(); }
}

document.getElementById("formAccidente").addEventListener("submit", function(e){
  e.preventDefault();
  const data = Object.fromEntries(new FormData(this).entries());
  data.action = data.row ? "update" : "insert";

  fetch(URL, {method:"POST", body:JSON.stringify(data)})
  .then(r=>r.json()).then(res=>{
    document.getElementById("mensaje").innerText = res.result==="ok" ? "‚úÖ Guardado con √©xito" : "‚ùå Error";
    this.reset(); this.row.value="";
    cargarDatos();
  });
});

function cargarDatos(){
  fetch(URL).then(r=>r.json()).then(rows=>{
    let thead = document.querySelector("#tablaDatos thead");
    let tbody = document.querySelector("#tablaDatos tbody");
    thead.innerHTML=""; tbody.innerHTML="";
    if(rows.length===0) return;
    // encabezados
    let headers = Object.keys(rows[0]);
    thead.innerHTML = "<tr><th>#</th>"+headers.map(h=>"<th>"+h+"</th>").join("")+"<th>Acciones</th></tr>";
    // filas
    rows.forEach((r,i)=>{
      let tr="<tr><td>"+(i+2)+"</td>";
      headers.forEach(h=> tr+="<td>"+(r[h]||"")+"</td>");
      tr+=`<td>
        <button class="action" onclick='editar(${i+2},${JSON.stringify(r)})'>‚úèÔ∏è</button>
        <button class="action" onclick='eliminar(${i+2})'>üóëÔ∏è</button>
      </td></tr>`;
      tbody.innerHTML+=tr;
    });
  });
}

function editar(row,data){
  mostrar('form1');
  let f=document.getElementById("formAccidente");
  for(let k in data){ if(f[k]) f[k].value=data[k]; }
  f.row.value=row;
}

function eliminar(row){
  if(!confirm("¬øEliminar registro?")) return;
  fetch(URL,{method:"POST",body:JSON.stringify({action:"delete",row:row})})
  .then(r=>r.json()).then(()=>cargarDatos());
}

function filtrar(){
  let pais=document.getElementById("filtroPais").value.toLowerCase();
  let anio=document.getElementById("filtroAnio").value.toLowerCase();
  document.querySelectorAll("#tablaDatos tbody tr").forEach(tr=>{
    let c=tr.cells;
    let match=(!pais||c[1].innerText.toLowerCase().includes(pais)) &&
              (!anio||c[4].innerText.toLowerCase().includes(anio));
    tr.style.display=match?"":"none";
  });
}

// Exportar a CSV
function exportarCSV(){
  let filas=[...document.querySelectorAll("#tablaDatos tr")];
  let csv=filas.map(tr=>{
    let cols=[...tr.querySelectorAll("th,td")].map(td=>`"${td.innerText}"`);
    return cols.join(",");
  }).join("\n");
  let blob=new Blob([csv],{type:"text/csv"});
  let link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="accidentes.csv";
  link.click();
}
</script>
</body>
</html>


